apiVersion: v1
kind: ConfigMap
metadata:
  name: project-brain-config
  namespace: project-brain
  labels:
    app: project-brain
    component: configuration
data:
  # =========================
  # Configuración del sistema
  # =========================
  system.yaml: |
    system:
      name: "Project Brain"
      version: "1.0.0"
      environment: "production"
      log_level: "INFO"
      data_directory: "/app/data"
      log_directory: "/app/logs"

    projects:
      supported_extensions:
        python: [".py", ".pyx", ".pyi"]
        javascript: [".js", ".jsx"]
        typescript: [".ts", ".tsx"]
        java: [".java"]
        cpp: [".c", ".cpp", ".h", ".hpp"]
        go: [".go"]
        rust: [".rs"]

      exclude_patterns:
        - "**/node_modules/**"
        - "**/.git/**"
        - "**/.idea/**"
        - "**/.vscode/**"
        - "**/__pycache__/**"
        - "**/*.min.js"
        - "**/*.min.css"

    api:
      rest:
        host: "0.0.0.0"
        port: 8000

      websocket:
        host: "0.0.0.0"
        port: 8001

      authentication:
        enabled: true
        method: "jwt"

      rate_limiting:
        enabled: true
        requests_per_minute: 60

  # =========================
  # Configuración mínima Nginx
  # (solo si se usa sidecar)
  # =========================
  nginx.conf: |
    user nginx;
    worker_processes auto;

    events {
        worker_connections 1024;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        sendfile        on;
        keepalive_timeout  65;

        upstream api_backend {
            least_conn;
            server project-brain-api:8000;
        }

        server {
            listen 8080;
            server_name _;

            location / {
                proxy_pass http://api_backend;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            location /health {
                proxy_pass http://api_backend/health;
                access_log off;
            }
        }
    }

  # =========================
  # Script de inicialización
  # =========================
  init-script.sh: |
    #!/usr/bin/env bash
    set -euo pipefail

    echo "[INIT] Inicializando Project Brain..."
    sleep 10

    if [ -f /app/scripts/init_system.py ]; then
      python3 /app/scripts/init_system.py
    else
      echo "[INIT] Script init_system.py no encontrado"
      exit 1
    fi

    echo "[INIT] Inicialización completada."

  # =========================
  # Health check script
  # =========================
  health-check.sh: |
    #!/usr/bin/env bash
    set -e

    curl -fs http://localhost:8000/health > /dev/null
