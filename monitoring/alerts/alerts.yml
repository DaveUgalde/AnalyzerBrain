groups:

  - name: system_availability
    rules:
      - alert: SystemDown
        expr: up{job="project_brain_api"} == 0
        for: 2m
        labels:
          severity: critical
          component: api
          team: devops
        annotations:
          summary: "Sistema Project Brain caído"
          description: "El servicio API de Project Brain ha estado caído por más de 2 minutos"
          runbook_url: "https://wiki.projectbrain.dev/runbooks/system-down"

      - alert: DatabaseDown
        expr: up{job=~"(postgres_exporter|redis_exporter|neo4j_exporter)"} == 0
        for: 3m
        labels:
          severity: critical
          component: database
          team: devops
        annotations:
          summary: "Base de datos caída"
          description: "El exporter {{ $labels.job }} no responde por más de 3 minutos"
          runbook_url: "https://wiki.projectbrain.dev/runbooks/database-down"

      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="project_brain_api",status=~"5.."}[5m]))
            /
            clamp_min(sum(rate(http_requests_total{job="project_brain_api"}[5m])), 1)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          component: api
          team: devops
        annotations:
          summary: "Alta tasa de errores HTTP"
          description: "Más del 5% de las requests devuelven 5xx"

  - name: system_performance
    rules:
      - alert: HighResponseTime
        expr: |
          histogram_quantile(
            0.95,
            sum by (le) (
              rate(http_request_duration_seconds_bucket{job="project_brain_api"}[5m])
            )
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          component: api
          team: devops
        annotations:
          summary: "Alto tiempo de respuesta API"
          description: "El P95 del tiempo de respuesta supera 500ms"

      - alert: HighPostgresLatency
        expr: |
          rate(pg_stat_database_xact_commit[5m]) == 0
        for: 5m
        labels:
          severity: warning
          component: database
          team: devops
        annotations:
          summary: "PostgreSQL sin commits"
          description: "No se registran commits en PostgreSQL"

      - alert: HighRedisLatency
        expr: |
          histogram_quantile(
            0.95,
            sum by (le) (
              rate(redis_command_duration_seconds_bucket[5m])
            )
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          component: cache
          team: devops
        annotations:
          summary: "Alta latencia Redis"
          description: "P95 de comandos Redis > 50ms"

      - alert: LowCacheHitRate
        expr: project_brain_cache_hit_rate < 0.8
        for: 10m
        labels:
          severity: warning
          component: cache
          team: devops
        annotations:
          summary: "Baja tasa de acierto de caché"
          description: "Cache hit rate por debajo de 80%"

  - name: system_resources
    rules:
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: critical
          component: infrastructure
          team: devops
        annotations:
          summary: "Alto uso de memoria"
          description: "Uso de memoria superior al 90%"

      - alert: HighCPUUsage
        expr: |
          1 - avg by (instance) (
            rate(node_cpu_seconds_total{mode="idle"}[5m])
          ) > 0.85
        for: 5m
        labels:
          severity: warning
          component: infrastructure
          team: devops
        annotations:
          summary: "Alto uso de CPU"
          description: "Uso sostenido de CPU superior al 85%"

      - alert: HighDiskUsage
        expr: |
          (1 - node_filesystem_avail_bytes{mountpoint="/"} /
               node_filesystem_size_bytes{mountpoint="/"}) > 0.9
        for: 10m
        labels:
          severity: critical
          component: infrastructure
          team: devops
        annotations:
          summary: "Alto uso de disco"
          description: "Disco raíz por encima del 90%"

  - name: application_specific
    rules:
      - alert: HighQueueLength
        expr: project_brain_queue_length > 100
        for: 5m
        labels:
          severity: warning
          component: queue
          team: devops
        annotations:
          summary: "Cola de procesamiento larga"
          description: "Más de 100 trabajos en cola"

      - alert: AnalysisTimeout
        expr: project_brain_analysis_time_seconds > 1800
        for: 2m
        labels:
          severity: warning
          component: analysis
          team: devops
        annotations:
          summary: "Análisis excediendo tiempo límite"
          description: "Un análisis supera los 30 minutos"

  - name: business_metrics
    rules:
      - alert: NoProjectsAnalyzed
        expr: increase(project_brain_projects_analyzed_total[24h]) == 0
        for: 1h
        labels:
          severity: warning
          component: business
          team: product
        annotations:
          summary: "Sin proyectos analizados en 24h"
          description: "No se procesaron proyectos en el último día"

  - name: security
    rules:
      - alert: HighFailedLoginAttempts
        expr: rate(project_brain_failed_login_attempts_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
          component: security
          team: security
        annotations:
          summary: "Muchos intentos de login fallidos"
          description: "Posible ataque de fuerza bruta"

      - alert: UnauthorizedAccessAttempt
        expr: increase(project_brain_unauthorized_access_attempts_total[5m]) > 0
        for: 2m
        labels:
          severity: critical
          component: security
          team: security
        annotations:
          summary: "Acceso no autorizado detectado"
          description: "Se detectaron accesos no autorizados recientes"

  - name: external_services
    rules:
      - alert: ExternalAPIUnavailable
        expr: up{job="blackbox",instance=~".*external.*"} == 0
        for: 5m
        labels:
          severity: warning
          component: external
          team: devops
        annotations:
          summary: "API externa no disponible"
          description: "Una dependencia externa no responde"
